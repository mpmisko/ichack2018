#!/usr/bin/nodejs

/*
 * @author Xunnamius
 */

const shell  = require('shelljs');
const gulp   = require('gulp');
gulp.plugins = require('gulp-load-plugins')();

process.chdir(__dirname);

gulp.task('default', ['run-tests', 'make-api']);
gulp.task('run-tests', () => gulp.src('tests/**/*.js', { read: false }).pipe(gulp.plugins.mocha({ reporter: 'spec' })));
gulp.task('make-api', () => shell.exec(`jsdoc2md lib/**/*.js > API.md`));
gulp.task('make-docs', () =>
{
    shell.exec('rm -r docs/*', { silent: true }); // Should skip the .gitignore file!
    shell.exec(`jsdoc -c jsdoc.json`);
});

gulp.task('pre-publish', () =>
{
    let branch = shell.exec('git rev-parse --abbrev-ref HEAD', { silent: true }).stdout.trim();

    if(!['master', 'develop'].includes(branch))
    {
        gulp.plugins.util.log(`publish failed prematurely: branch name "${branch}" not recognized`);
        process.exit(1);
    }

    shell.rm('.publishrc');
    shell.cp(`configs/publish-${branch}.json`, '.publishrc');
    shell.exec('git push --tags');
});
